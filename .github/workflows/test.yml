name: Test Site

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 9am UTC
    - cron: '0 9 * * *'

env:
  # For local file testing
  SITE_BASE_URL: ${{ github.event_name == 'pull_request' && 'https://hanscho.com' || 'http://localhost:3000' }}

jobs:
  # ==========================================
  # 1. Link Checking
  # ==========================================
  link-check:
    name: Check Broken Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Links
        uses: lycheeverse/lychee-action@v1
        with:
          args: |
            --no-progress
            --exclude-mail
            --timeout 30
            --exclude "https://hanscho.com/*"
            ./
          fail: false
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      
      - name: Create Issue for Broken Links
        if: failure()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ðŸ”— Broken Links Detected"
          content-filepath: ./lychee/out.md
          labels: bug, automated

  # ==========================================
  # 2. Lighthouse Performance
  # ==========================================
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x
      
      - name: Run Lighthouse CI
        run: |
          lhci autorun --config=lighthouserc.json || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: ./.lighthouseci/

  # ==========================================
  # 3. JavaScript Console Error Checking
  # ==========================================
  console-error-check:
    name: Check for JS Console Errors
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm install puppeteer
      
      - name: Check Console Errors (Production)
        if: github.event_name == 'schedule' || github.event_name == 'push'
        run: node .github/scripts/check-console-errors.js
        env:
          SITE_URL: 'https://hanscho.com'
      
      - name: Check Console Errors (Local with Server)
        if: github.event_name == 'pull_request'
        run: |
          npx http-server -p 3000 &
          sleep 3
          SITE_URL=http://localhost:3000 node .github/scripts/check-console-errors.js

  # ==========================================
  # 4. JSON Validation
  # ==========================================
  json-valid:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate JSON Syntax
        run: |
          for file in $(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*"); do
            echo "Checking $file..."
            python3 -c "import json; json.load(open('$file'))" || echo "INVALID: $file"
          done

  # ==========================================
  # 5. JSON Schema Validation (NEW)
  # ==========================================
  json-schema-validation:
    name: Validate food-data.json Schema
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate Food Data Schema
        run: node tests/setup/validate-food-data.js

  # ==========================================
  # 6. Screenshot Diff Testing (NEW)
  # ==========================================
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Install Playwright Browsers
        run: npx playwright install chromium
      
      - name: Run Visual Regression Tests
        run: npx playwright test --config=playwright.comprehensive.config.js
        env:
          CI: true
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: |
            test-results/
            !test-results/**/*.webm
          retention-days: 7
      
      - name: Upload Baseline Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-baselines
          path: tests/visual/__snapshots__/
          retention-days: 30
      
      - name: Upload Actual Screenshots on Failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-actual-screenshots
          path: test-results/visual-artifacts/
          retention-days: 7

  # ==========================================
  # 7. Mobile Viewport Testing (NEW)
  # ==========================================
  mobile-viewport-tests:
    name: Mobile Viewport Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Install Playwright Browsers
        run: npx playwright install chromium
      
      - name: Run Mobile Viewport Tests
        run: npx playwright test tests/visual/comprehensive-visual.spec.js --project=chromium --grep "Mobile Viewport Testing"
        env:
          CI: true
      
      - name: Upload Mobile Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-viewport-results
          path: test-results/
          retention-days: 7

  # ==========================================
  # 8. E2E Navigation Tests
  # ==========================================
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Install Playwright Browsers
        run: npx playwright install
      
      - name: Run E2E Tests
        run: npm run test:e2e
        env:
          CI: true
      
      - name: Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 7

  # ==========================================
  # 9. Summary Report (NEW)
  # ==========================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [link-check, lighthouse, console-error-check, json-valid, json-schema-validation, visual-regression, mobile-viewport-tests, e2e-tests]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Test Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Link Check | ${{ needs.link-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lighthouse | ${{ needs.lighthouse.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Console Errors | ${{ needs.console-error-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Validation | ${{ needs.json-valid.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Schema | ${{ needs.json-schema-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Visual Regression | ${{ needs.visual-regression.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile Viewport | ${{ needs.mobile-viewport-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if any critical tests failed
          if [[ "${{ needs.json-schema-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.visual-regression.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
            echo "âŒ **Critical tests failed!** Please check the artifacts and logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **All critical tests passed!**" >> $GITHUB_STEP_SUMMARY
          fi
