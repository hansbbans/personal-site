name: Test Site

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 9am UTC
    - cron: '0 9 * * *'

jobs:
  link-check:
    name: Check Broken Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Links
        uses: lycheeverse/lychee-action@v1
        with:
          args: |
            --no-progress
            --exclude-mail
            --timeout 30
            ./
          fail: false
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      
      - name: Create Issue for Broken Links
        if: failure()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ðŸ”— Broken Links Detected"
          content-filepath: ./lychee/out.md
          labels: bug, automated

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x
      
      - name: Run Lighthouse CI
        run: |
          lhci autorun --config=lighthouserc.json || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: ./.lighthouseci/

  console-error-check:
    name: Check for JS Console Errors
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer
        run: npm install puppeteer
      
      - name: Check Console Errors
        run: node .github/scripts/check-console-errors.js
        env:
          SITE_URL: ${{ github.event_name == 'pull_request' && 'https://hanscho.com' || 'file://' + github.workspace + '/' }}

  json-valid:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate JSON
        run: |
          for file in $(find . -name "*.json" -not -path "./node_modules/*"); do
            echo "Checking $file..."
            python3 -c "import json; json.load(open('$file'))" || echo "INVALID: $file"
          done
